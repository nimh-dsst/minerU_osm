# MinerU Silent Failure Troubleshooting

## Problem Summary

MinerU silently fails on ~47% of PDFs without raising exceptions. The wrapper script (`process_pdfs_mineru.py`) marked these as "completed" because `PDFExtractor.extract()` returned without error, but no output files were generated.

**Discovery Date:** 2025-01-06

## Observed Symptoms

### Processing Time Correlation

| Chunk Type | Time per PDF | Output | Interpretation |
|------------|--------------|--------|----------------|
| Failed | 10-46 sec | None | Container startup only, no actual MinerU processing |
| Success | 200-600 sec (K80) | Files exist | Full MinerU pipeline execution |

**Key Indicator:** Processing time <50 seconds strongly suggests silent failure.

### Statistics

| Metric | Value |
|--------|-------|
| Result CSVs marked "completed" | 253,443 |
| Actual output directories | 134,688 |
| Missing (silent failures) | 172,631 (~68% of "completed") |
| Overlap (completed AND have output) | 80,812 |
| Have output but NOT in CSVs | 53,876 |

### Example Failed PDF

```
PMID: 12657658
PDF: /data/NIMH_scratch/adamt/osm/datalad-osm/pdfs/126/12657658.pdf
Size: 312 KB
Type: PDF document, version 1.4
Processing Time: 21.5 seconds
Output: None (directory doesn't exist)
pdftotext: Works (text is extractable)
```

## Bug Fixes Applied

### 1. False "completed" Status (Fixed)

**Before:** Script set `status = "completed"` unconditionally after `extractor.extract()` returned.

**After:** Script now verifies `{pmid}_content_list.json` exists before marking success:
```python
if json_path.exists():
    result["status"] = "completed"
else:
    result["status"] = "failed"
    result["error_msg"] = "No output files generated by MinerU"
```

### 2. Empty Directory Cleanup (Fixed)

Script now removes empty output directories on failure to prevent inode waste.

### 3. Double-Nested Directories (Fixed)

**Before:** `{prefix}/{pmid}/{pmid}/auto/`
**After:** `{prefix}/{pmid}/auto/`

## Root Cause Hypotheses

### 1. GPU Initialization Failure

MinerU may fail to initialize CUDA/GPU on certain nodes without raising an exception. The 10-46 second processing time matches container startup overhead.

**Evidence:**
- Chunk 00010 ran on cn2355 (A100 node)
- All 40 PDFs in that chunk failed with 10-46 sec times
- No CUDA errors in stderr

**Investigation:** Compare failure rates across GPU types (K80, P100, V100, A100).

### 2. Model Loading Failure

MinerU's pipeline backend loads multiple models:
- `doclayout_yolo` (layout detection)
- `MFD/unimernet` (formula detection)
- `RapidTable/UnetTable` (table recognition)
- `PP-OCRv5` (OCR)

If any model fails to load, the pipeline may silently skip processing.

**Investigation:** Enable MinerU debug logging to trace model loading.

### 3. Early PDF Rejection

MinerU may detect something about the PDF (encryption, corruption, format) that causes it to skip processing without error.

**Evidence Against:** `pdftotext` works on the sample failed PDF.

**Investigation:** Test specific failed PDFs manually with verbose output.

### 4. Resource Exhaustion

GPU memory or system resources may be exhausted, causing MinerU to skip processing.

**Evidence Against:**
- Only 6GB VRAM needed, K80 has 12GB
- Same chunk processes all 40 PDFs at same speed (not progressive slowdown)

## GitHub Issues Referenced

- [Issue #4139](https://github.com/opendatalab/MinerU/issues/4139): Empty output with VLLM backend (different backend, but similar pattern)
- [Issue #2481](https://github.com/opendatalab/MinerU/issues/2481): Text loss during parsing

## Investigation Plan

### Step 1: GPU Type Correlation Analysis

Parse job logs to extract:
- Node name (indicates GPU type: cn2xxx=A100, cn3xxx=V100, cn4xxx=K80)
- Processing times per PDF
- Success/failure status

```bash
# Extract node and chunk info from logs
for log in /data/adamt/osm/datafiles/mineru_logs/small/swarm_8644416_*.o; do
    chunk=$(basename $log | sed 's/swarm_8644416_\([0-9]*\).o/\1/')
    node=$(grep -m1 'cn[0-9]*' $log 2>/dev/null | head -1)
    times=$(grep '✓\|✗' $log | awk '{print $NF}' | tr -d '()s')
    echo "$chunk,$node,$times"
done
```

### Step 2: Manual Testing with Debug Logging

Test a known-failing PDF with verbose output:

```bash
# Interactive GPU session
sinteractive --gres=gpu:1 --mem=64g

# Load container
module load apptainer
source /usr/local/current/singularity/app_conf/sing_binds

# Run with debug
apptainer exec --nv /data/adamt/containers/mineru.sif python3 -c "
import logging
logging.basicConfig(level=logging.DEBUG)
from mineru.pdf_extractor import PDFExtractor
extractor = PDFExtractor(
    pdf_path='/data/NIMH_scratch/adamt/osm/datalad-osm/pdfs/126/12657658.pdf',
    output_dir='/tmp/test_output'
)
extractor.extract()
"
```

### Step 3: Batch Diagnostic Run

Create a diagnostic swarm that:
1. Captures GPU info (`nvidia-smi`)
2. Logs MinerU model loading
3. Tests a sample of known-failing PDFs
4. Reports detailed timing breakdowns

## Data Files

- **Missing PMIDs:** `/tmp/missing_pmids.txt` (172,631 PMIDs marked completed but no output)
- **Existing PMIDs:** `/tmp/existing_pmids.txt` (134,688 PMIDs with actual output)
- **Completed PMIDs:** `/tmp/completed_pmids.txt` (253,443 PMIDs marked completed in CSVs)

## Next Steps

1. [ ] Analyze GPU type correlation with failure rate
2. [ ] Run manual debug test on failing PDF
3. [ ] Enable MinerU debug logging in wrapper script
4. [ ] Consider alternative: retry failed PDFs with different backend (vlm vs pipeline)
5. [ ] Report issue to MinerU GitHub if root cause is in MinerU itself
