Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04

%labels
    Author Adam Thomas
    Version 1.1-p100
    Description MinerU PDF-to-JSON container with P100 GPU support
    PyTorch 2.3.1+cu118
    CUDA_Compute_Capability 6.0+

%post
    # Update and install base dependencies
    apt-get update && apt-get install -y --no-install-recommends \
        python3.11 \
        python3.11-venv \
        python3-pip \
        libgl1-mesa-glx \
        libglib2.0-0 \
        libsm6 \
        libxext6 \
        libxrender-dev \
        git \
        wget \
        && rm -rf /var/lib/apt/lists/*

    # Set python3.11 as default
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1
    update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1

    # Upgrade pip
    python3 -m pip install --upgrade pip

    # Install MinerU first (will pull torch 2.9.x)
    pip3 install --no-cache-dir "mineru[core]"

    # FORCE reinstall PyTorch 2.3.1 with CUDA 11.8 (supports sm_60/P100)
    # This overwrites the incompatible torch 2.9.x that mineru pulled in
    pip3 install --no-cache-dir --force-reinstall \
        torch==2.3.1+cu118 \
        torchvision==0.18.1+cu118 \
        --index-url https://download.pytorch.org/whl/cu118

    # Install additional dependencies
    pip3 install --no-cache-dir \
        pandas \
        pyarrow \
        duckdb

    # Clean up
    apt-get clean
    rm -rf /var/cache/apt/archives/*

%environment
    export LC_ALL=C
    export LANG=C.UTF-8
    export PATH=/usr/local/bin:$PATH
    export CUDA_VISIBLE_DEVICES=0

%runscript
    exec mineru "$@"

%test
    python3 -c "import mineru; print(f'MinerU version: {mineru.__version__}')"
    python3 -c "import torch; print(f'PyTorch version: {torch.__version__}')"
    python3 -c "import torch; print(f'PyTorch CUDA available: {torch.cuda.is_available()}')"
    python3 -c "import torch; caps = torch.cuda.get_arch_list(); print(f'Supported architectures: {caps}')"

%help
    MinerU PDF-to-JSON container with P100 GPU support.

    This container uses PyTorch 2.3.1+cu118 which supports:
    - P100 (compute capability 6.0) - GPU mode
    - V100/V100x (compute capability 7.0) - GPU mode
    - A100 (compute capability 8.0) - GPU mode
    - K80 (compute capability 3.7) - CPU fallback only

    Usage:
        # Direct MinerU CLI
        apptainer run --nv mineru_p100.sif -p input.pdf -o output/

        # Python script
        apptainer exec --nv mineru_p100.sif python3 process_pdfs_mineru.py --help

    GPU Requirements:
        - Pipeline backend: 6GB VRAM minimum
        - VLM backend: 8GB VRAM minimum
